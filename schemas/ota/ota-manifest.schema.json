{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://schemas.alteriom.io/ota/ota-manifest.schema.json",
  "title": "Alteriom OTA Manifest",
  "description": "Schema for OTA firmware manifest (rich and minimal variants with optional chunk hashing).",
  "type": "object",
  "oneOf": [
    { "$ref": "#/definitions/richManifest" },
    { "$ref": "#/definitions/minimalEnvMap" }
  ],
  "definitions": {
    "chunkObject": {
      "type": "object",
      "required": ["index", "offset", "size", "sha256"],
      "properties": {
        "index": { "type": "integer", "minimum": 0 },
        "offset": { "type": "integer", "minimum": 0 },
        "size": { "type": "integer", "minimum": 1 },
        "sha256": { "type": "string", "pattern": "^[a-f0-9]{64}$" }
      },
      "additionalProperties": false
    },
    "richEntry": {
      "type": "object",
      "required": ["build_type", "file", "size", "sha256", "firmware_version", "built", "ota_url"],
      "properties": {
        "build_type": { "type": "string", "enum": ["dev", "prod"] },
        "file": { "type": "string", "pattern": "^firmware-(dev|prod)\\.bin$" },
        "size": { "type": "integer", "minimum": 1 },
        "sha256": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
        "firmware_version": { "type": "string" },
        "built": { "type": "string", "format": "date-time" },
        "ota_url": { "type": "string" },
        "chunk_size": { "type": "integer", "minimum": 4096 },
        "chunks": {
          "oneOf": [
            { "type": "array", "items": { "$ref": "#/definitions/chunkObject" } },
            { "type": "array", "items": { "type": "string", "pattern": "^[a-f0-9]{64}$" } }
          ]
        }
      },
      "additionalProperties": false
    },
    "richManifest": {
      "type": "object",
      "required": ["environment", "branch", "manifests"],
      "properties": {
        "environment": { "type": "string" },
        "branch": { "type": "string" },
        "manifests": {
          "type": "object",
          "properties": {
            "dev": { "$ref": "#/definitions/richEntry" },
            "prod": { "$ref": "#/definitions/richEntry" }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "minimalChannel": {
      "type": "object",
      "required": ["file", "size", "sha256", "version", "timestamp"],
      "properties": {
        "file": { "type": "string" },
        "size": { "type": "integer", "minimum": 1 },
        "sha256": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
        "version": { "type": "string" },
        "timestamp": { "type": "string" },
        "chunk_size": { "type": "integer", "minimum": 1 },
        "chunks": { "type": "array", "items": { "type": "string", "pattern": "^[a-f0-9]{64}$" } }
      },
      "additionalProperties": false
    },
    "minimalEnv": {
      "type": "object",
      "properties": {
        "dev": { "$ref": "#/definitions/minimalChannel" },
        "prod": { "$ref": "#/definitions/minimalChannel" }
      },
      "additionalProperties": false
    },
    "minimalEnvMap": {
      "type": "object",
      "patternProperties": {
        "^[a-zA-Z0-9_-]+$": { "$ref": "#/definitions/minimalEnv" }
      },
      "additionalProperties": false,
      "minProperties": 1
    }
  }
}
