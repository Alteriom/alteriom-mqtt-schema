{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.alteriom.io/mqtt/v1/firmware_status.schema.json",
  "title": "Firmware Update Status v1 (Enhanced v0.7.2)",
  "description": "Enhanced OTA firmware update status with command support, scheduling, and improved validation",
  "allOf": [{"$ref": "envelope.schema.json"}],
  "type": "object",
  "required": ["status"],
  "properties": {
    "event": {"type": "string", "description": "Event type (e.g., 'ota_command', 'ota_status', 'ota_schedule')"},
    "from_version": {"type": "string", "description": "Current firmware version before update"},
    "to_version": {"type": "string", "description": "Target firmware version after update"},
    "status": {"type": "string", "enum": ["idle", "pending", "scheduled", "downloading", "download_paused", "flashing", "verifying", "rebooting", "completed", "failed", "cancelled", "rolled_back", "rollback_pending", "rollback_failed"], "description": "Current OTA update status"},
    "progress_pct": {"type": "number", "minimum": 0, "maximum": 100, "description": "Update progress percentage (0-100)"},
    "error": {"type": ["string", "null"], "description": "Human-readable error message"},
    "error_code": {"type": "string", "maxLength": 64, "description": "Machine-readable error code for diagnostics"},
    "retry_count": {"type": "integer", "minimum": 0, "description": "Number of retry attempts for this update"},
    "max_retries": {"type": "integer", "minimum": 0, "description": "Maximum allowed retry attempts"},
    "download_speed_kbps": {"type": "number", "minimum": 0, "description": "Current download speed in kilobits per second"},
    "bytes_downloaded": {"type": "integer", "minimum": 0, "description": "Number of bytes downloaded so far"},
    "bytes_total": {"type": "integer", "minimum": 0, "description": "Total bytes to download"},
    "eta_seconds": {"type": "integer", "minimum": 0, "description": "Estimated time remaining in seconds"},
    "update_started_at": {"type": "string", "format": "date-time", "description": "ISO8601 timestamp when update began"},
    "update_completed_at": {"type": "string", "format": "date-time", "description": "ISO8601 timestamp when update completed or failed"},
    "scheduled_at": {"type": "string", "format": "date-time", "description": "ISO8601 timestamp when update is scheduled to start"},
    "deadline": {"type": "string", "format": "date-time", "description": "ISO8601 timestamp deadline for update completion"},
    "rollback_available": {"type": "boolean", "description": "Whether rollback to previous version is available"},
    "previous_version": {"type": "string", "description": "Version to rollback to if update fails"},
    "update_type": {"type": "string", "enum": ["full", "delta", "patch", "configuration"], "description": "Type of update being applied"},
    "update_channel": {"type": "string", "enum": ["stable", "beta", "dev", "custom"], "description": "Update channel/track"},
    "update_priority": {"type": "string", "enum": ["low", "normal", "high", "critical"], "description": "Update priority level"},
    "signature_verified": {"type": "boolean", "description": "Whether firmware signature was successfully verified"},
    "checksum_verified": {"type": "boolean", "description": "Whether firmware checksum was successfully verified"},
    "checksum_algorithm": {"type": "string", "enum": ["md5", "sha1", "sha256", "sha512"], "description": "Checksum algorithm used"},
    "expected_checksum": {"type": "string", "description": "Expected checksum value"},
    "actual_checksum": {"type": "string", "description": "Actual calculated checksum value"},
    "free_space_kb": {"type": "integer", "minimum": 0, "description": "Available storage space in kilobytes before update"},
    "required_space_kb": {"type": "integer", "minimum": 0, "description": "Required storage space for update in kilobytes"},
    "battery_level_pct": {"type": "number", "minimum": 0, "maximum": 100, "description": "Battery level during update (critical for battery-powered devices)"},
    "min_battery_required_pct": {"type": "number", "minimum": 0, "maximum": 100, "description": "Minimum battery level required to proceed with update"},
    "force_update": {"type": "boolean", "description": "Whether this is a mandatory forced update"},
    "allow_downgrade": {"type": "boolean", "description": "Whether downgrading to older version is allowed"},
    "auto_reboot": {"type": "boolean", "description": "Whether device will automatically reboot after update"},
    "backup_config": {"type": "boolean", "description": "Whether device configuration was backed up before update"},
    "update_source": {"type": "string", "description": "Source/URL of firmware update"},
    "update_manifest_url": {"type": "string", "format": "uri", "description": "URL to OTA manifest file"},
    "correlation_id": {"type": "string", "maxLength": 128, "description": "Correlation ID linking command to status updates"},
    "phase": {"type": "string", "enum": ["preparation", "download", "validation", "installation", "verification", "finalization", "cleanup"], "description": "Current update phase"},
    "cancellable": {"type": "boolean", "description": "Whether update can be cancelled at this stage"},
    "pause_reason": {"type": "string", "description": "Reason for download pause (if download_paused)"},
    "validation_errors": {"type": "array", "items": {"type": "string"}, "description": "List of validation errors if verification failed"}
  },
  "additionalProperties": true
}
