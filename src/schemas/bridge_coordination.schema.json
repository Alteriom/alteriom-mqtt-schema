{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.alteriom.io/mqtt/v1/bridge_coordination.schema.json",
  "title": "Bridge Coordination Message",
  "description": "Multi-bridge coordination and load balancing protocol (Type 613)",
  "type": "object",
  "allOf": [
    {
      "$ref": "envelope.schema.json"
    }
  ],
  "properties": {
    "message_type": {
      "const": 613,
      "description": "Message type code for bridge coordination messages"
    },
    "event": {
      "const": "bridge_coordination",
      "description": "Event identifier for multi-bridge coordination"
    },
    "data": {
      "type": "object",
      "required": [
        "bridge_node_id",
        "bridge_role",
        "bridge_priority",
        "load_percentage"
      ],
      "properties": {
        "bridge_node_id": {
          "type": "integer",
          "description": "Unique identifier of the coordinating bridge",
          "minimum": 1
        },
        "bridge_role": {
          "type": "string",
          "enum": ["primary", "secondary", "backup", "standby"],
          "description": "Current role in multi-bridge coordination"
        },
        "bridge_priority": {
          "type": "integer",
          "description": "Bridge priority for conflict resolution (0-255)",
          "minimum": 0,
          "maximum": 255
        },
        "peer_bridges": {
          "type": "array",
          "description": "List of other active bridges in the mesh",
          "items": {
            "type": "object",
            "required": ["bridge_node_id", "bridge_role", "last_seen"],
            "properties": {
              "bridge_node_id": {
                "type": "integer",
                "description": "Peer bridge node ID",
                "minimum": 1
              },
              "bridge_role": {
                "type": "string",
                "enum": ["primary", "secondary", "backup", "standby"],
                "description": "Peer bridge role"
              },
              "internet_connected": {
                "type": "boolean",
                "description": "Peer Internet connectivity status"
              },
              "router_rssi": {
                "type": "integer",
                "description": "Peer router RSSI",
                "minimum": -200,
                "maximum": 0
              },
              "load_percentage": {
                "type": "number",
                "description": "Peer bridge load percentage",
                "minimum": 0,
                "maximum": 100
              },
              "health_status": {
                "type": "string",
                "enum": ["healthy", "degraded", "warning", "critical"],
                "description": "Peer bridge health status"
              },
              "last_seen": {
                "type": "string",
                "format": "date-time",
                "description": "Last status update from peer bridge (ISO 8601)"
              }
            },
            "additionalProperties": true
          }
        },
        "load_percentage": {
          "type": "number",
          "description": "Current bridge load percentage (0-100)",
          "minimum": 0,
          "maximum": 100
        },
        "connected_nodes": {
          "type": "integer",
          "description": "Number of mesh nodes using this bridge",
          "minimum": 0
        },
        "messages_relayed_1m": {
          "type": "integer",
          "description": "Messages relayed in last minute",
          "minimum": 0
        },
        "selection_strategy": {
          "type": "string",
          "enum": ["priority_based", "round_robin", "best_signal", "load_balanced", "manual"],
          "description": "Strategy for selecting bridge for new connections"
        },
        "traffic_routing": {
          "type": "object",
          "description": "Traffic routing configuration by message type",
          "properties": {
            "alarm_messages": {
              "type": "string",
              "enum": ["primary_only", "all_bridges", "best_signal"],
              "description": "Routing strategy for alarm messages"
            },
            "sensor_data": {
              "type": "string",
              "enum": ["load_balanced", "primary_only", "round_robin"],
              "description": "Routing strategy for sensor telemetry"
            },
            "control_commands": {
              "type": "string",
              "enum": ["primary_only", "any_available", "best_signal"],
              "description": "Routing strategy for control commands"
            },
            "firmware_updates": {
              "type": "string",
              "enum": ["primary_only", "dedicated_bridge", "best_signal"],
              "description": "Routing strategy for OTA firmware updates"
            }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    }
  }
}
